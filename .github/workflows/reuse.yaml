
name: action pour cloner un repo
on: 
  workflow_call:
    inputs:
      channel_id:
        required: true
        type: string
      dependency_track_project_name:
        required: true
        type: string
    secrets:
      slack_token:
        required: true
        #type: string
      sonar_token:
        required: true
      sonar_host_url:
        required: true
      dependency_track_api_key:
        required: true
      host:
        required: true
      username:
        required: true
      port:
        required: true
      key:
        required: true
        
jobs: 
  build:
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 1
      fail-fast: false
      matrix:
        php: [8.2,8.1]
        
    steps:
    # - name: clone repo
    #   uses: actions/checkout@v3

    # - name: Setup PHP with PECL extension
    #   uses: shivammathur/setup-php@v2
    #   with:
    #     php-version: ${{ matrix.php }}
    #     extensions: imagick, swoole

    # - name: keygenerate
    #   run: |
    #       composer install --prefer-dist
    #       composer update
    #       cp .env.example .env
    #       php artisan key:generate 

    # - name: testexec
    #   run: |
    #       php artisan test

    # - name: dockerbuild
    #   run: |
    #       docker build . 

    # - name: SonarQube Scan
    #   uses: sonarsource/sonarqube-scan-action@master
    #   env:
    #     SONAR_TOKEN: ${{ secrets.sonar_token }}
    #     SONAR_HOST_URL: ${{ secrets.sonar_host_url }}

    # - name: Generate SBOM with CycloneDX
    #   run: |
    #     composer config --no-plugins allow-plugins.cyclonedx/cyclonedx-php-composer true
    #     composer require --dev cyclonedx/cyclonedx-php-composer
    #     composer update
    #     composer CycloneDX:make-sbom --output-file=sbom.xml
         
    # - name: Dependency Track
    #   run: |
    #     curl -X "POST" "http://13.60.7.234:8081/api/v1/bom" \
    #     -H 'Content-Type: multipart/form-data' \
    #     -H "X-Api-Key: ${{ secrets.dependency_track_api_key }}" \
    #     -F "autoCreate=true" \
    #     -F "projectName=${{ inputs.dependency_track_project_name }}" \
    #     -F "projectVersion=1.0" \
    #     -F "bom=@./sbom.xml"

    - name: copy file via ssh key
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.host }}
        username: ${{ secrets.username }}
        port: ${{ secrets.port }}
        key: ${{ secrets.key }}
        source: .
        target: /home/

    - name: Post to a Slack channel
      id: slack
      if: ${{ always() }}
      uses: slackapi/slack-github-action@v1.25.0
      with:
        # Slack channel id, channel name, or user id to post message.
        # See also: https://api.slack.com/methods/chat.postMessage#channels
        # You can pass in multiple channels to post to by providing a comma-delimited list of channel IDs.
        #channel-id: ${{ vars.CHANNEL_ID }}
        channel-id: ${{ inputs.channel_id }}
        # For posting a simple plain text message
        #Envoie le messsage sur le canal slack le message devra contenir le status du job, Le numero du build, le runner surlequel ceci a été executé, le nom du workflow, le github repository
        slack-message: "GitHub build result: ${{ job.status }}\n Nom du build :${{github.job}}\n Numero du build :${{github.sha}} \n Auteur :${{github.actor}}"
      env:
        #SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        SLACK_BOT_TOKEN: ${{ secrets.slack_token }}


      



 
